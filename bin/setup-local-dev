#!/bin/bash
# Setup script for local development with OpenTelemetry Ruby Contrib
# This script configures Bundler to use your local repository for gem dependencies

REPO_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TEMP_CONFIG_DIR="$REPO_PATH/.bundle-template"

# Check if --clean flag is provided
if [ "$1" = "--clean" ]; then
  echo "OpenTelemetry Ruby Contrib - Removing Local Development Configuration"
  echo "======================================================================"
  echo ""

  DIR_COUNT=0

  # Clean config in each gem directory
  while IFS= read -r gemspec_path; do
    GEM_DIR=$(dirname "$gemspec_path")

    if [ -d "$GEM_DIR/.bundle" ]; then
      rm -rf "$GEM_DIR/.bundle"
      ((DIR_COUNT++))
    fi
  done < <(find "$REPO_PATH" -name "*.gemspec" -type f)

  # Clean template directory
  rm -rf "$TEMP_CONFIG_DIR"

  echo "[OK] Removed .bundle directories from $DIR_COUNT gem directories."
  echo ""
  exit 0
fi

echo "OpenTelemetry Ruby Contrib - Local Development Setup"
echo "===================================================="
echo ""
echo "Repository path: $REPO_PATH"
echo ""

# Generate template bundle config once
echo "Generating bundle configuration template..."
mkdir -p "$TEMP_CONFIG_DIR/.bundle"
cd "$REPO_PATH"

# Create the config file directly
CONFIG_FILE="$TEMP_CONFIG_DIR/.bundle/config"
echo "---" > "$CONFIG_FILE"

# Disable local branch and revision checking to allow working on any branch/commit
echo "BUNDLE_DISABLE_LOCAL_BRANCH_CHECK: \"true\"" >> "$CONFIG_FILE"
echo "BUNDLE_DISABLE_LOCAL_REVISION_CHECK: \"true\"" >> "$CONFIG_FILE"

GEM_COUNT=0
while IFS= read -r gemspec_path; do
  GEM_NAME=$(basename "$gemspec_path" .gemspec)
  # Convert gem name to bundle config format (replace - and _ with ___)
  CONFIG_KEY=$(echo "$GEM_NAME" | sed 's/[-_]/___/g' | tr '[:lower:]' '[:upper:]')
  echo "BUNDLE_LOCAL__${CONFIG_KEY}: \"$REPO_PATH\"" >> "$CONFIG_FILE"
  ((GEM_COUNT++))
done < <(find "$REPO_PATH" -name "*.gemspec" -type f)

echo "[OK] Generated configuration with $GEM_COUNT local gem references"
echo ""

# Copy template to each gem directory that has git dependencies
echo "Copying configuration to gem directories..."
echo ""

DIR_COUNT=0

# Find all directories with Gemfiles that reference git sources
while IFS= read -r gemfile_path; do
  GEM_DIR=$(dirname "$gemfile_path")

  # Check if this Gemfile has git references to our repo
  if grep -q "git:.*open-telemetry/opentelemetry-ruby-contrib" "$gemfile_path" 2>/dev/null; then
    mkdir -p "$GEM_DIR/.bundle"
    cp "$TEMP_CONFIG_DIR/.bundle/config" "$GEM_DIR/.bundle/config"
    echo "  [OK] Configured $(basename $GEM_DIR)"
    ((DIR_COUNT++))
  fi

done < <(find "$REPO_PATH" -name "Gemfile" -type f)

# Clean up template
rm -rf "$TEMP_CONFIG_DIR"

echo ""
echo "[OK] Configuration complete!"
echo "[OK] Configured $DIR_COUNT gem directories with git dependencies"
echo ""
echo "You can now work on any gem and your changes will be"
echo "immediately available to dependent gems."
echo ""
echo "Example workflow:"
echo "  1. Edit code in instrumentation/base/"
echo "  2. cd instrumentation/rails/"
echo "  3. bundle install"
echo "  4. bundle exec rake test"
echo ""
echo "Your local changes from instrumentation/base will be used!"
echo ""
echo "To verify your configuration:"
echo "  cd instrumentation/rails && bundle config local.opentelemetry-instrumentation-base"
echo ""
echo "To remove all local overrides:"
echo "  $REPO_PATH/bin/setup-local-dev --clean"
echo ""
echo "For more information, see docs/local-development.md"
