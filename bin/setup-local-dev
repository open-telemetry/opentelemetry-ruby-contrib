#!/bin/bash
# Setup script for local development with OpenTelemetry Ruby Contrib
# This script configures Bundler to use your local repository for gem dependencies

REPO_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
TEMP_CONFIG_DIR="$REPO_PATH/.bundle-template"

# Check if --clean flag is provided
if [ "$1" = "--clean" ]; then
  echo "OpenTelemetry Ruby Contrib - Removing Local Development Configuration"
  echo "======================================================================"
  echo ""

  DIR_COUNT=0

  # Clean config in each gem directory
  while IFS= read -r gemspec_path; do
    GEM_DIR=$(dirname "$gemspec_path")

    if [ -d "$GEM_DIR/.bundle" ]; then
      rm -rf "$GEM_DIR/.bundle"
      ((DIR_COUNT++))
    fi
  done < <(find "$REPO_PATH" -name "*.gemspec" -type f)

  # Clean template directory
  rm -rf "$TEMP_CONFIG_DIR"

  echo "[OK] Removed .bundle directories from $DIR_COUNT gem directories."
  echo ""
  exit 0
fi

echo "OpenTelemetry Ruby Contrib - Local Development Setup"
echo "===================================================="
echo ""
echo "Repository path: $REPO_PATH"
echo ""

# Get all gem names
ALL_GEM_NAMES=()
while IFS= read -r gemspec_path; do
  GEM_NAME=$(basename "$gemspec_path" .gemspec)
  ALL_GEM_NAMES+=("$GEM_NAME")
done < <(find "$REPO_PATH" -name "*.gemspec" -type f)

echo "Generating bundle configuration template with all gems..."
echo ""

# Create template config directory
mkdir -p "$TEMP_CONFIG_DIR/.bundle"

# Generate the .bundle/config file manually as YAML
cat > "$TEMP_CONFIG_DIR/.bundle/config" << EOF
---
BUNDLE_DISABLE_LOCAL_BRANCH_CHECK: "true"
BUNDLE_DISABLE_LOCAL_REVISION_CHECK: "true"
EOF

# Add local overrides for ALL gems to the template
for GEM_NAME in "${ALL_GEM_NAMES[@]}"; do
  # Convert gem name to bundle config key format:
  # hyphens and underscores become triple underscores, then uppercase
  CONFIG_KEY=$(echo "$GEM_NAME" | sed 's/[-_]/___/g' | tr '[:lower:]' '[:upper:]')
  echo "BUNDLE_LOCAL__${CONFIG_KEY}: \"$REPO_PATH\"" >> "$TEMP_CONFIG_DIR/.bundle/config"
done

echo "[OK] Template configuration generated with ${#ALL_GEM_NAMES[@]} gems"
echo ""
echo "Copying configuration to gem directories..."
echo ""

DIR_COUNT=0

# Find all directories with Gemfiles that reference git sources
while IFS= read -r gemfile_path; do
  GEM_DIR=$(dirname "$gemfile_path")

  # Check if this Gemfile has git references to our repo
  if grep -q "git:.*open-telemetry/opentelemetry-ruby-contrib" "$gemfile_path" 2>/dev/null; then
    # Copy the template config
    mkdir -p "$GEM_DIR/.bundle"
    cp "$TEMP_CONFIG_DIR/.bundle/config" "$GEM_DIR/.bundle/config"

    # Find the gemspec in this directory to exclude it from local overrides
    CURRENT_GEM=""
    if ls "$GEM_DIR"/*.gemspec 1> /dev/null 2>&1; then
      CURRENT_GEM=$(basename "$GEM_DIR"/*.gemspec .gemspec 2>/dev/null | head -1)

      # Remove the current gem's local override by deleting the line from the config file
      CONFIG_KEY=$(echo "$CURRENT_GEM" | sed 's/[-_]/___/g' | tr '[:lower:]' '[:upper:]')
      sed -i '' "/^BUNDLE_LOCAL__${CONFIG_KEY}:/d" "$GEM_DIR/.bundle/config"
    fi

    echo "  [OK] Configured $(basename $GEM_DIR) (excluded: $CURRENT_GEM)"
    ((DIR_COUNT++))
  fi

done < <(find "$REPO_PATH" -name "Gemfile" -type f)

echo ""
echo "[OK] Configuration complete!"
echo "[OK] Configured $DIR_COUNT gem directories with git dependencies"
echo ""
echo "You can now work on any gem and your changes will be"
echo "immediately available to dependent gems."
echo ""
echo "Example workflow:"
echo "  1. Edit code in instrumentation/base/"
echo "  2. cd instrumentation/rails/"
echo "  3. bundle install"
echo "  4. bundle exec rake test"
echo ""
echo "Your local changes from instrumentation/base will be used!"
echo ""
echo "To verify your configuration:"
echo "  cd instrumentation/rails && bundle config local.opentelemetry-instrumentation-base"
echo ""
echo "To remove all local overrides:"
echo "  $REPO_PATH/bin/setup-local-dev --clean"
echo ""
echo "For more information, see guides/local-development.md"
